{% extends "account/base.html" %}
{% load static %}
{% block content %}
<div class="chat-wrapper">
  <h2>ðŸ”’ Private chat with {{ other.get_full_name|default:other.username }}</h2>

  <!-- message feed -->
  <div id="chat-log"></div>

  <!-- input bar -->
  <form id="chat-form">
    <input id="chat-message-input"
           type="text"
           placeholder="Type messageâ€¦"
           maxlength="500"
           autocomplete="off"
           required>
    <button id="chat-message-submit">Send</button>
  </form>
</div>

<style>
  .chat-wrapper { max-width: 500px; margin: 2rem auto; font-family: system-ui, sans-serif; }
  #chat-log { height: 300px; border: 1px solid #ccc; overflow-y: auto; padding: .5rem; margin-bottom: .5rem; }
  .msg { margin: .25rem 0; word-break: break-word; }
  .msg.me  { color: #2563eb; }
  .msg.you { color: #1f2937; }
  #chat-form { display: flex; gap: .5rem; }
  #chat-form input { flex: 1; padding: .5rem; }
  #chat-form button { padding: .5rem 1rem; }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const otherUser = "{{ other.username }}";
    const wsScheme  = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/private/${otherUser}/`);

    const logDiv   = document.getElementById('chat-log');
    const form     = document.getElementById('chat-form');
    const input    = document.getElementById('chat-message-input');

    // --- incoming ---
    chatSocket.onmessage = (e) => {
      const data   = JSON.parse(e.data);
      const isMe   = data.sender === "{{ user.username }}";
      const div    = document.createElement('div');
      div.className = `msg ${isMe ? 'me' : 'you'}`;
      div.textContent = `${data.sender}: ${data.text}`;
      logDiv.appendChild(div);
      logDiv.scrollTop = logDiv.scrollHeight;
    };

    // --- outgoing ---
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const msg = input.value.trim();
      if (msg) {
        chatSocket.send(JSON.stringify({message: msg}));
        input.value = '';
      }
    });

    // keep input focused
    input.focus();
  });
</script>
{% endblock %}